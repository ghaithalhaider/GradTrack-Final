<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GradTrack | Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</title>
    <link rel="stylesheet" href="../student/css/style.css">
    <style>
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            gap: 15px;
        }

        .step-dot {
            width: 12px;
            height: 12px;
            background: #e2e8f0;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .step-dot.active {
            background: var(--primary);
            transform: scale(1.2);
        }

        .token-success {
            border-color: #48bb78 !important;
            background-color: #f0fff4 !important;
        }
    </style>
</head>

<body>

    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h2>ğŸ“ Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</h2>
                <p>Ø³Ø¬Ù„ Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</p>
            </div>

            <!-- Steps Indicator -->
            <div class="step-indicator">
                <div class="step-dot active" id="dot1"></div>
                <div class="step-dot" id="dot2"></div>
            </div>

            <!-- Step 1: Token Entry -->
            <div id="step1">
                <form id="tokenForm" class="auth-form">
                    <div class="form-group">
                        <label>ÙƒÙˆØ¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… (Active Token)</label>
                        <input type="text" id="tokenInput" class="auth-input" placeholder="Ù…Ø«Ø§Ù„: PROF-AB1234-99"
                            style="text-align: center; font-family: monospace; letter-spacing: 2px; font-weight: bold; text-transform: uppercase;"
                            required>
                    </div>
                    <button type="submit" class="auth-btn">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯</button>
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="supervisor-login.html"
                            style="color: #666; font-size: 0.9em; text-decoration: none;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
                    </div>
                </form>
            </div>

            <!-- Step 2: Profile & Account -->
            <div id="step2" style="display: none;">
                <form id="registerForm" class="auth-form">
                    <input type="hidden" id="validTokenId">

                    <div class="form-group">
                        <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ø§Ù„Ù„Ù‚Ø¨ Ø§Ù„Ø¹Ù„Ù…ÙŠ + Ø§Ù„Ø§Ø³Ù…)</label>
                        <input type="text" id="fullName" class="auth-input" placeholder="Ø¯. Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ..." required>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</label>
                            <input type="text" value="Ø¬Ø§Ù…Ø¹Ø© ÙƒØ±Ø¨Ù„Ø§Ø¡" class="auth-input" readonly
                                style="background:#f7fafc; color:#718096;">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„ÙƒÙ„ÙŠØ©</label>
                            <input type="text" value="Ø¹Ù„ÙˆÙ… Ø§Ù„Ø­Ø§Ø³ÙˆØ¨" class="auth-input" readonly
                                style="background:#f7fafc; color:#718096;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Ø§Ù„Ù‚Ø³Ù…</label>
                        <select id="department" class="auth-input" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…...</option>
                            <option value="Ø¹Ù„ÙˆÙ… Ø­Ø§Ø³ÙˆØ¨">Ø¹Ù„ÙˆÙ… Ø­Ø§Ø³ÙˆØ¨</option>
                            <!-- Add other departments if needed -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ</label>
                        <input type="email" id="email" class="auth-input" placeholder="name@uokerbala.edu.iq" required>
                    </div>

                    <div class="form-group">
                        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <input type="password" id="password" class="auth-input" placeholder="******" required
                            minlength="6">
                    </div>

                    <button type="submit" class="auth-btn">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
                    <button type="button" onclick="location.reload()"
                        style="background:none; border:none; width:100%; margin-top:10px; color:#666; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
                </form>
            </div>

            <div id="error-msg"
                style="color:#e53e3e; text-align:center; display:none; margin-top:15px; font-weight:600; padding: 10px; background: #fff5f5; border-radius: 8px;">
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from '../student/js/firebase-config.js';
        import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            collection, query, where, getDocs, doc, setDoc, updateDoc, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const tokenForm = document.getElementById('tokenForm');
        const registerForm = document.getElementById('registerForm');
        const errorMsg = document.getElementById('error-msg');

        let validTokenCode = null;
        let validTokenDocId = null;

        function showError(msg) {
            errorMsg.textContent = msg;
            errorMsg.style.display = 'block';
            setTimeout(() => errorMsg.style.display = 'none', 5000);
        }

        // STEP 1: Verify Token
        tokenForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const inputToken = document.getElementById('tokenInput').value.trim();
            const btn = tokenForm.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
            btn.disabled = true;

            try {
                const q = query(
                    collection(db, "professorTokens"),
                    where("token", "==", inputToken),
                    where("status", "==", "active")
                );

                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    throw new Error("Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹.");
                }

                // Token Valid
                const tokenDoc = snapshot.docs[0];
                validTokenCode = tokenDoc.data().token;
                validTokenDocId = tokenDoc.id;

                // Move to Step 2
                document.getElementById('step1').style.display = 'none';
                document.getElementById('step2').style.display = 'block';
                document.getElementById('dot1').classList.remove('active');
                document.getElementById('dot2').classList.add('active');

            } catch (error) {
                console.error(error);
                showError(error.message);
                btn.disabled = false;
                btn.innerText = originalText;
            }
        });

        // STEP 2: Register
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = registerForm.querySelector('button[type="submit"]');
            btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...';
            btn.disabled = true;

            const fullName = document.getElementById('fullName').value;
            const dept = document.getElementById('department').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                // 1. Create Auth
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                const user = cred.user;

                // 2. Create Supervisor Doc
                await setDoc(doc(db, "supervisors", user.uid), {
                    uid: user.uid,
                    name: fullName,
                    email: email,
                    department: dept,
                    university: "Ø¬Ø§Ù…Ø¹Ø© ÙƒØ±Ø¨Ù„Ø§Ø¡",
                    college: "Ø¹Ù„ÙˆÙ… Ø§Ù„Ø­Ø§Ø³ÙˆØ¨", // Could be dynamic if needed
                    role: "supervisor",
                    projectsCount: 0,
                    joinedAt: serverTimestamp(),
                    joinToken: validTokenCode
                });

                // 3. Mark Token as Used
                await updateDoc(doc(db, "professorTokens", validTokenDocId), {
                    status: 'used',
                    usedBy: user.uid,
                    usedByName: fullName,
                    usedByEmail: email,
                    usedAt: new Date().toISOString()
                });

                // Done
                alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….');
                window.location.href = '../supervisor/dashboard.html';

            } catch (error) {
                console.error(error);
                showError("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: " + error.message);
                btn.disabled = false;
                btn.innerText = 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨';
            }
        });

    </script>
</body>

</html>